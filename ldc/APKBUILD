# Contributor: Mathias LANG <pro.mathias.lang@gmail.com>
# Maintainer: Mathias LANG <pro.mathias.lang@gmail.com>
pkgname=ldc
pkgver=1.18.0
pkgrel=0
pkgdesc="The LLVM-based D Compiler"
url="https://github.com/ldc-developers/ldc"
# Bootstrapping was done with an upstream-provided package,
# with only x86_64 available
# Once we can use GDC for bootstrapping, this can be "all"
arch="x86_64"
license="BSD-3-Clause AND BSL-1.0 AND (Artistic-1.0 OR GPL-2.0-or-later) AND NCSA AND MIT"
depends="binutils-gold libexecinfo"
makedepends="chrpath cmake dlang-compiler llvm8-dev llvm8-static curl-dev libedit-dev libexecinfo-static zlib-dev"
# A user might want to install the '-runtime' subpackage when they have
# a dynamically-linked D program.
subpackages="$pkgname-runtime $pkgname-doc $pkgname-static"
provides="dlang-compiler"
source="https://github.com/ldc-developers/ldc/releases/download/v$pkgver/ldc-$pkgver-src.tar.gz
		ldc2.package.conf"
builddir="$srcdir/"

build() {
	rootdir="$srcdir/ldc-$pkgver-src/"

	cd "$rootdir"
	if [ "$CBUILD" != "$CHOST" ]; then
		CMAKE_CROSSOPTS="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	cmake \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=True \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_CXX_FLAGS="$CXXFLAGS" \
		-DCMAKE_C_FLAGS="$CFLAGS" \
		$CMAKE_CROSSOPTS "$rootdir"
	make

	# CMake added the rpaths to the shared libs - strip them
	chrpath -d "$rootdir"/lib/*.so*
	:
}

check() {
	rootdir="$srcdir/ldc-$pkgver-src/"

	echo 'import std.stdio; void main () { try throw new Exception(null); catch (Exception) writeln("Hello World!"); }' > hello_world.d
	if [ "$($rootdir/bin/ldmd2 -run hello_world.d)" != "Hello World!" ]; then
		return 1
	fi
	:
}

package() {
	depends="$pkgname-runtime $pkgname-static"
	rootdir="$srcdir/ldc-$pkgver-src/"
	importdir="$pkgdir/usr/include/dlang/$pkgname-$pkgver/"

	install -s -D "$rootdir/bin/ldc2"  "$pkgdir/usr/bin/ldc2"
	install -s -D "$rootdir/bin/ldmd2" "$pkgdir/usr/bin/ldmd2"
	# Needed for PGO
	install -s -D "$rootdir/bin/ldc-profdata"  "$pkgdir/usr/bin/ldc-profdata"
	# Needed for LDC compile cache management
	install -s -D "$rootdir/bin/ldc-prune-cache"  "$pkgdir/usr/bin/ldc-prune-cache"

	install -D "$srcdir/ldc2.package.conf" "$pkgdir/etc/ldc2.conf"

	install -D "$rootdir/LICENSE" "$pkgdir/usr/share/licenses/$pkgname/LICENSE"

	# Install LDC import files
	for impfile in $(find "$rootdir/runtime/jit-rt/d/" -name "*.d*");
	do
		target="${impfile##*jit-rt/d/}"
		install -D "$impfile" "$rootdir/runtime/$target"
	done

	# Install Druntime import files
	install -D "$rootdir/runtime/druntime/src/object.d" "$importdir/object.d"
	for importpkg in "core" "etc" "gc" "ldc" "rt";
	do
		cp -R "$rootdir/runtime/druntime/src/$importpkg/" "$importdir/"
	done

	# Install Phobos import files
	for importpkg in "etc" "std";
	do
		cp -R "$rootdir/runtime/phobos/$importpkg/" "$importdir/"
	done

	# Install the static & shared runtime libraries
	mkdir -p "$pkgdir/usr/lib/"
	cp -R "$rootdir"/lib/* "$pkgdir/usr/lib/"
}

runtime() {
	depends="libexecinfo-dev"
	pkgdesc="Dynamic runtime library for D code compiled with $pkgname-$pkgver"

	mkdir -p "$subpkgdir/usr/lib/"
	for libn in "libdruntime" "libphobos2";
	do
		mv "$pkgdir"/usr/lib/$libn-ldc-shared.so* "$subpkgdir/usr/lib/"
	done
	mv "$pkgdir"/usr/lib/libldc-jit.so* "$subpkgdir/usr/lib"

	mv "$pkgdir"/usr/lib/*.so* "$subpkgdir/usr/lib/"
	:
}

static() {
	depends="libexecinfo-static"
	pkgdesc="$pkgdesc (static library)"

	mkdir -p "$subpkgdir/usr/lib/"
	mv "$pkgdir"/usr/lib/*.a "$subpkgdir/usr/lib/"
}

sha512sums="fe7529c33d0e43dfb71f474dfa381b88ee476b70933c8f80fc063d9a015df24a75e2b607a7242cc4b9cd4b6ac7559aec8f2883016bf7252342742322fcccbd4d  ldc-1.18.0-src.tar.gz
0e5f67604d36dbf3943feb3dee3b55f0f2fe1659ce4efc2c189b535934f351868973fb31e94ffa2fd7a910ced3b9258058d43157e25e298f0fa7edd81842bcea  ldc2.package.conf"
