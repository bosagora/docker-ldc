# -*- shell-script -*-
# Contributor: Mathias LANG <pro.mathias.lang@gmail.com>
# Maintainer: Mathias LANG <pro.mathias.lang@gmail.com>
#
# This package is divided between the actual package,
# and the two subpackages, `static` and `runtime`.
# The main package depends on them.
# A user might want to install `runtime` when they have
# a dynamically-linked D program.
pkgname="ldc"
pkgver="1.8.0"
pkgrel=0
pkgdesc="The LLVM-based D Compiler"
url="https://github.com/ldc-developers/ldc"
arch="x86_64"
license="BSD-3-Clause; Some parts BSL-1.0; Some parts Artistic-1.0 or GPL-2.0-or-later; Some parts NCSA; Some parts NCSA and MIT"
depends="libexecinfo"
makedepends="chrpath cmake llvm5-libs libexecinfo-static"
install=""
subpackages="$pkgname-runtime $pkgname-doc $pkgname-static"
provides="dlang-compiler"
source="https://github.com/ldc-developers/ldc/releases/download/v1.8.0/ldc2-1.8.0-alpine-linux-x86_64.tar.xz
		ldc2.conf"
builddir="$srcdir/"

build() {
	# Unfortunately the upstream-provided version has the builder's /home/ in its rpath - strip it
	chrpath -d "$srcdir/ldc2-1.8.0-alpine-linux-x86_64/bin/ldc2"
	chrpath -d "$srcdir/ldc2-1.8.0-alpine-linux-x86_64/bin/ldmd2"
	# This exe is not installed, just used in build, but do it for completeness
	chrpath -d "$srcdir/ldc2-1.8.0-alpine-linux-x86_64/bin/ldc-build-runtime"

	# Now build the runtime - the compiler itself is already built by upstream
	"$srcdir"/ldc2-1.8.0-alpine-linux-x86_64/bin/ldc-build-runtime --buildDir="$srcdir/ldc-runtime-build/"

	# CMake added the rpaths to the shared libs - strip them
	chrpath -d "$srcdir"/ldc-runtime-build/lib/*.so
	:
}

check() {
	root="$srcdir/ldc2-1.8.0-alpine-linux-x86_64/"
	libroot="$srcdir/ldc-runtime-build/lib/"

	echo 'import std.stdio; void main () { try throw new Exception(null); catch (Exception) writeln("Hello World!"); }' > hello_world.d
	if [ "$(${root}/bin/ldmd2 -conf='' -I${root}/import/ldc -I${root}/import/ -L-L${libroot} -defaultlib=phobos2-ldc,druntime-ldc -L-lexecinfo -L-rpath=${libroot} -run hello_world.d)" != "Hello World!" ]; then
		return 1
	fi
	:
}

package() {
	depends="$pkgname-runtime $pkgname-static"

	install -s -D "$srcdir/ldc2-1.8.0-alpine-linux-x86_64/bin/ldc2"	 "$pkgdir"/usr/bin/ldc2
	install -s -D "$srcdir/ldc2-1.8.0-alpine-linux-x86_64/bin/ldmd2" "$pkgdir"/usr/bin/ldmd2

	install -D "$srcdir/ldc2.conf" "$pkgdir/etc/ldc2.conf"

	install -D "$srcdir/ldc2-1.8.0-alpine-linux-x86_64/LICENSE" "$pkgdir/usr/share/licenses/$pkgname/LICENSE"

	# Install the import file
	for impfile in $(find "$srcdir/ldc2-1.8.0-alpine-linux-x86_64/import" -name "*.d*");
	do
		target="${impfile##*import/}"
		install -D "$impfile" "$pkgdir/usr/include/dlang/$pkgname-$pkgver/$target"
	done

	# Install the static runtime libraries
	for libn in "libdruntime-ldc" "libdruntime-ldc-debug" "libphobos2-ldc" "libphobos2-ldc-debug";
	do
		install -D "$srcdir/ldc-runtime-build/lib/${libn}.a" "$pkgdir/usr/lib/${libn}.a"
	done

	# Install the shared runtime libraries
	for libn in "libdruntime" "libphobos2";
	do
		install -D "$srcdir/ldc-runtime-build/lib/${libn}-ldc-shared.so.2.0.78" "$pkgdir/usr/lib/${libn}-ldc-shared.so.2.0.78"
	done
}

runtime() {
	depends="libexecinfo-dev"
	pkgdesc="Dynamic runtime library for D code compiled with $pkgname-$pkgver"

	mkdir -p "$subpkgdir"/usr/lib/
	for libn in "libdruntime" "libphobos2";
	do
		mv "$pkgdir/usr/lib/${libn}-ldc-shared.so.2.0.78" "$subpkgdir/usr/lib/${libn}-ldc-shared.so.2.0.78"
		ln -s "${libn}-ldc-shared.so.2.0.78" "$pkgdir/usr/lib/${libn}-ldc-shared.so.78"
		ln -s "${libn}-ldc-shared.so.2.0.78" "$pkgdir/usr/lib/${libn}-ldc-shared.so"
	done

	mv "$pkgdir"/usr/lib/*.so* "$subpkgdir"/usr/lib/
	:
}

static() {
	depends="libexecinfo-static"
	pkgdesc="$pkgdesc (static library)"

	mkdir -p "$subpkgdir"/usr/lib/
	mv "$pkgdir"/usr/lib/*.a "$subpkgdir"/usr/lib/
}

sha512sums="3a870c9e7e9500d4e2a47e53d10cb10641319223200e3730abf9b6debf1c261cef11bac0b797ee2aa66c63c950461326273e0c14685b6d641155de307997e1af  ldc2-1.8.0-alpine-linux-x86_64.tar.xz
0fd1613ffdd52db1f486ad15bc5f2df2f2f1b94bddf12d67a38897f73cd83d5d222bb184dd88df1058be9f9d31fdb6c8d6850d6ce672d25e4a0cbbf579d248a1  ldc2.conf"
